---
- name: gather facts
  setup:

- name: add official rethinkdb apt repository
  register: _repo
  become: True
  apt_repository:
    repo: deb http://download.rethinkdb.com/apt {{ansible_distribution_release}} main

- name: add apt rethinkdb repository key
  register: _repo_key
  become: True
  apt_key:
    url: https://download.rethinkdb.com/apt/pubkey.gpg

- name: update package list
  when: _repo.changed or _repo_key.changed
  become: True
  apt:
    update_cache: True

- name: install rethinkdb
  become: True
  apt:
    name: rethinkdb
    allow_unauthenticated: True
  retries: 5
  delay: 10

- name: stop rethinkdb service
  become: True
  service:
    name: rethinkdb
    state: stopped

- name: reset rethinkdb data
  become: True
  file:
    path: /var/lib/rethinkdb/default
    state: absent

- name: install pip package
  become: True
  apt:
    name: python-pip

- name: install rethinkdb python driver
  become: True
  pip:
    name: rethinkdb
